<!DOCTYPE html>
<html>
<head>
    <title>Controller Diagnostic Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #2d2d2d;
            color: #fff;
        }
        h1 { color: #00ff00; }
        #status { font-size: 24px; margin: 20px 0; }
        #data { 
            background: #1a1a1a; 
            padding: 20px; 
            border: 2px solid #444;
            white-space: pre;
            min-height: 300px;
        }
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .warning { color: #ffff00; }
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover { background: #0088ff; }
    </style>
</head>
<body>
    <h1>üéÆ Xbox Controller Diagnostic Test</h1>
    
    <div id="status" class="warning">‚è≥ Waiting for controller input...</div>
    
    <button onclick="pollGamepads()">üîÑ Manual Poll</button>
    <button onclick="startPolling()">‚ñ∂Ô∏è Start Auto-Poll</button>
    <button onclick="stopPolling()">‚è∏Ô∏è Stop Auto-Poll</button>
    
    <h2>Instructions:</h2>
    <ol>
        <li>Make sure your Xbox controller is connected via USB-C</li>
        <li>Click "Manual Poll" or press ANY button on the controller</li>
        <li>Watch for status changes below</li>
    </ol>
    
    <div id="data">No data yet. Press a button or click Manual Poll.</div>

    <script>
        let pollingInterval = null;
        
        // Event listeners for gamepad connection
        window.addEventListener('gamepadconnected', (e) => {
            console.log('‚úÖ gamepadconnected event fired!');
            document.getElementById('status').innerHTML = 
                '<span class="success">‚úÖ Connected: ' + e.gamepad.id + '</span>';
            displayGamepadInfo(e.gamepad);
        });

        window.addEventListener('gamepaddisconnected', (e) => {
            console.log('‚ùå gamepaddisconnected event fired');
            document.getElementById('status').innerHTML = 
                '<span class="error">‚ùå Disconnected: ' + e.gamepad.id + '</span>';
        });

        function pollGamepads() {
            const gamepads = navigator.getGamepads();
            console.log('Polling gamepads...', gamepads);
            
            let found = false;
            let output = 'Poll Time: ' + new Date().toLocaleTimeString() + '\n\n';
            output += 'Navigator.getGamepads() returned: ' + gamepads.length + ' slots\n\n';
            
            for (let i = 0; i < gamepads.length; i++) {
                const gp = gamepads[i];
                if (gp) {
                    found = true;
                    output += `üéÆ GAMEPAD FOUND IN SLOT ${i}!\n`;
                    output += '‚îÅ'.repeat(60) + '\n';
                    output += `ID: ${gp.id}\n`;
                    output += `Index: ${gp.index}\n`;
                    output += `Connected: ${gp.connected}\n`;
                    output += `Timestamp: ${gp.timestamp}\n`;
                    output += `Mapping: ${gp.mapping}\n`;
                    output += `Buttons: ${gp.buttons.length}\n`;
                    output += `Axes: ${gp.axes.length}\n\n`;
                    
                    output += 'AXES (Analog Sticks):\n';
                    output += `  Left Stick X (axis 0):  ${gp.axes[0]?.toFixed(3) || 'N/A'}\n`;
                    output += `  Left Stick Y (axis 1):  ${gp.axes[1]?.toFixed(3) || 'N/A'}\n`;
                    output += `  Right Stick X (axis 2): ${gp.axes[2]?.toFixed(3) || 'N/A'}\n`;
                    output += `  Right Stick Y (axis 3): ${gp.axes[3]?.toFixed(3) || 'N/A'}\n\n`;
                    
                    output += 'BUTTONS:\n';
                    gp.buttons.forEach((btn, index) => {
                        if (btn.pressed || btn.value > 0) {
                            output += `  Button ${index}: PRESSED (value: ${btn.value.toFixed(3)})\n`;
                        }
                    });
                    
                    document.getElementById('status').innerHTML = 
                        '<span class="success">‚úÖ Controller Active: ' + gp.id + '</span>';
                } else {
                    output += `Slot ${i}: null\n`;
                }
            }
            
            if (!found) {
                output += '\n‚ùå NO GAMEPADS DETECTED\n\n';
                output += 'Troubleshooting:\n';
                output += '1. Is the controller plugged in via USB-C?\n';
                output += '2. Try unplugging and replugging the controller\n';
                output += '3. Check System Preferences > Security & Privacy > Input Monitoring\n';
                output += '4. Make sure Chrome is in the allowed list\n';
                output += '5. Try a different USB cable or port\n';
                output += '6. Press a button on the controller after connecting\n';
                
                document.getElementById('status').innerHTML = 
                    '<span class="error">‚ùå No controller detected</span>';
            }
            
            document.getElementById('data').textContent = output;
        }
        
        function displayGamepadInfo(gp) {
            pollGamepads();
        }
        
        function startPolling() {
            if (pollingInterval) return;
            pollingInterval = setInterval(pollGamepads, 100);
            console.log('Started auto-polling');
        }
        
        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
                console.log('Stopped auto-polling');
            }
        }
        
        // Auto-poll on page load
        setTimeout(() => {
            pollGamepads();
            console.log('Initial poll complete');
        }, 500);
        
        // Log API availability
        console.log('Gamepad API available:', !!navigator.getGamepads);
        console.log('Browser:', navigator.userAgent);
    </script>
</body>
</html>
